<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador USSD - PayJA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 40px;
            max-width: 1400px;
            width: 100%;
            justify-content: center;
            align-items: center;
        }
        
        .smartphone {
            width: 380px;
            height: 780px;
            background: #1c1c1e;
            border-radius: 50px;
            padding: 12px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            position: relative;
            flex-shrink: 0;
        }

        .smartphone::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 25px;
            background: #1c1c1e;
            border-radius: 0 0 20px 20px;
            z-index: 10;
        }

        .speaker {
            position: absolute;
            top: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 6px;
            background: #2c2c2e;
            border-radius: 10px;
            z-index: 11;
        }

        .screen {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 40px;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            height: 44px;
            background: #1c1c1e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .ussd-header {
            background: #667eea;
            padding: 20px;
            text-align: center;
            color: #fff;
            border-bottom: 1px solid #5568d3;
        }

        .ussd-header h1 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .ussd-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .screen-content {
            flex: 1;
            background: #fff;
            overflow-y: auto;
            padding: 20px;
        }

        .message-box {
            background: #f2f2f7;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-size: 15px;
            line-height: 1.5;
            color: #000;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message-box.user { background: #e8f0ff; }
        .message-box.error { background: #ffe8e8; color: #8b0000; }

        .input-area {
            background: #f2f2f7;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .ussd-input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 20px;
            background: #fff;
            font-size: 16px;
            outline: none;
            border: 2px solid #e0e0e0;
        }

        .ussd-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #667eea;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover:not(:disabled) { background: #5568d3; }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }

        .bottom-nav {
            height: 50px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 18px;
        }

        /* PAINEL DE CONTROLE */
        .control-panel {
            flex: 1;
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            max-width: 600px;
        }

        .panel-header h1 {
            font-size: 28px;
            color: #1c1c1e;
            margin-bottom: 8px;
        }

        .panel-header h1 i {
            margin-right: 10px;
        }

        .panel-header p {
            color: #8e8e93;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .status-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            color: #fff;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .status-label { font-size: 13px; opacity: 0.9; }
        .status-label i { margin-right: 8px; }
        .status-value { font-weight: 600; font-size: 14px; }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1c1c1e;
            margin: 25px 0 15px 0;
            border-top: 1px solid #e0e0e0;
            padding-top: 15px;
        }

        .section-title i {
            margin-right: 8px;
        }

        .action-button {
            width: 100%;
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 12px;
            transition: all 0.3s;
            background: #667eea;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .action-secondary {
            background: #ff9800;
        }

        .action-secondary:hover {
            background: #f57c00;
        }

        .action-green {
            background: #10b981;
        }

        .action-green:hover {
            background: #059669;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #8e8e93;
            margin-bottom: 8px;
        }

        .input-label i {
            margin-right: 6px;
        }

        .config-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-box strong i {
            margin-right: 8px;
        }

        @media (max-width: 1024px) {
            .container { flex-direction: column; }
            .control-panel { max-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SMARTPHONE SIMULADOR (REACT) -->
        <div id="phone-root"></div>

        <!-- PAINEL DE CONTROLE (VANILLA JS) -->
        <div class="control-panel">
            <div class="panel-header">
                <h1><i class="fas fa-gamepad"></i> Painel de Controle</h1>
                <p>Simulador USSD Standalone - PayJA</p>
            </div>

            <div class="info-box">
                <strong><i class="fas fa-database"></i> Base de Dados Local</strong>
                <p>Este simulador possui seu pr√≥prio banco de dados SQLite que armazena todos os n√∫meros registrados, sess√µes USSD e hist√≥rico de transa√ß√µes.</p>
            </div>

            <div class="status-card">
                <div class="status-row">
                    <span class="status-label"><i class="fas fa-signal"></i> Status da Conex√£o</span>
                    <span class="status-value" id="status">Verificando...</span>
                </div>
                <div class="status-row">
                    <span class="status-label"><i class="fas fa-phone"></i> Telefone Atual</span>
                    <span class="status-value" id="phone">875551234</span>
                </div>
                <div class="status-row">
                    <span class="status-label"><i class="fas fa-link"></i> Sess√£o Ativa</span>
                    <span class="status-value" id="session">Nenhuma</span>
                </div>
            </div>

            <button class="action-button" onclick="window.startUSSD()">
                <i class="fas fa-phone-alt"></i> *898# - Solicitar Empr√©stimo
            </button>
            <button class="action-button action-secondary" onclick="window.testAPI()">
                <i class="fas fa-plug"></i> Testar Conex√£o com API
            </button>
            <button class="action-button action-green" onclick="window.openCustomersDB()">
                <i class="fas fa-users"></i> Ver Clientes Registados
            </button>

            <div class="section-title"><i class="fas fa-cogs"></i> Configura√ß√£o</div>

            <div class="input-group">
                <label class="input-label"><i class="fas fa-mobile-alt"></i> N√∫mero de Telefone</label>
                <input 
                    type="text" 
                    class="config-input" 
                    id="phoneInput" 
                    value="875551234"
                    placeholder="Ex: 868801234"
                />
            </div>

            <div class="input-group">
                <label class="input-label"><i class="fas fa-server"></i> URL da API</label>
                <input 
                    type="text" 
                    class="config-input" 
                    id="apiUrl" 
                    value="http://localhost:3001"
                    readonly
                />
            </div>
        </div>
    </div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script>
        const { useState, useEffect, useRef } = React;
        const e = React.createElement;

        // ==================== REACT SMARTPHONE ====================
        function SmartphoneApp() {
            const [time, setTime] = useState(() => formatTime(new Date()));
            const [sessionId, setSessionId] = useState(null);
            const [messages, setMessages] = useState([
                { text: 'Bem-vindo ao Simulador USSD PayJA\n\nClique no bot√£o abaixo para iniciar.', kind: '' }
            ]);
            const [inputValue, setInputValue] = useState('');
            const [busy, setBusy] = useState(false);
            const contentRef = useRef(null);
            const inputRef = useRef(null);

            const API = 'http://localhost:3001/api/ussd';

            useEffect(() => {
                const id = setInterval(() => setTime(formatTime(new Date())), 1000);
                return () => clearInterval(id);
            }, []);

            useEffect(() => {
                if (contentRef.current) {
                    contentRef.current.scrollTop = contentRef.current.scrollHeight;
                }
            }, [messages]);

            function formatTime(date) {
                const h = String(date.getHours()).padStart(2, '0');
                const m = String(date.getMinutes()).padStart(2, '0');
                return h + ':' + m;
            }

            function addMessage(text, kind = '') {
                setMessages(prev => [...prev, { text, kind }]);
            }

            function startSession(phone) {
                setBusy(true);
                setSessionId(null);
                setMessages([{ text: '‚òéÔ∏è Discando *898#...\n\nValidando n√∫mero...', kind: '' }]);

                fetch(API + '/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phoneNumber: phone })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            setMessages([{ text: '‚ùå ' + data.error, kind: 'error' }]);
                            setBusy(false);
                            return;
                        }
                        setSessionId(data.sessionId);
                        setMessages([{ text: data.message, kind: '' }]);
                        setInputValue('');
                        inputRef.current?.focus();
                        setBusy(false);
                    })
                    .catch(err => {
                        setMessages([{ text: '‚ùå ' + err.message, kind: 'error' }]);
                        setBusy(false);
                    });
            }

            function handleSend() {
                if (!sessionId || !inputValue.trim() || busy) return;
                const userText = inputValue.trim();
                setInputValue('');
                addMessage('> ' + userText, 'user');
                setBusy(true);

                fetch(API + '/continue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId, userInput: userText })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.error) {
                            addMessage('‚ùå ' + data.error, 'error');
                            setSessionId(null);
                            setBusy(false);
                            return;
                        }
                        addMessage(data.message, '');
                        if (data.endSession) {
                            setSessionId(null);
                        }
                        setBusy(false);
                    })
                    .catch(err => {
                        addMessage('‚ùå ' + err.message, 'error');
                        setBusy(false);
                    });
            }

            function handleKeyDown(evt) {
                if (evt.key === 'Enter') handleSend();
            }

            // Expor para painel de controle
            window.startUSSD = () => {
                const phone = document.getElementById('phoneInput').value || '875551234';
                document.getElementById('phone').textContent = phone;
                startSession(phone);
            };

            return e('div', { className: 'smartphone' },
                e('div', { className: 'speaker' }),
                e('div', { className: 'screen' },
                    e('div', { className: 'status-bar' },
                        e('span', null, time),
                        e('span', null, 'üì∂ üì° üîã')
                    ),
                    e('div', { className: 'ussd-header' },
                        e('h1', null, '‚òéÔ∏è USSD Simulator'),
                        e('p', null, 'Disque *898# para iniciar')
                    ),
                    e('div', { className: 'screen-content', ref: contentRef },
                        messages.map((msg, idx) =>
                            e('div', { key: idx, className: 'message-box' }, msg.text)
                        )
                    ),
                    e('div', { className: 'input-area' },
                        e('input', {
                            type: 'text',
                            className: 'ussd-input',
                            placeholder: sessionId ? 'Digite aqui...' : 'Inicie com *898#',
                            value: inputValue,
                            onChange: (evt) => setInputValue(evt.target.value),
                            onKeyDown: handleKeyDown,
                            disabled: !sessionId || busy,
                            ref: inputRef
                        }),
                        e('button', {
                            className: 'send-btn',
                            onClick: handleSend,
                            disabled: !sessionId || busy
                        }, '‚û§')
                    ),
                    e('div', { className: 'bottom-nav' },
                        e('div', { className: 'nav-item' }, '‚åò'),
                        e('div', { className: 'nav-item' }, '‚úâ'),
                        e('div', { className: 'nav-item' }, 'üë•'),
                        e('div', { className: 'nav-item' }, '‚â°')
                    )
                )
            );
        }

        // ==================== RENDER ====================
        const root = ReactDOM.createRoot(document.getElementById('phone-root'));
        root.render(e(SmartphoneApp));

        // ==================== VANILLA JS PAINEL ====================
        async function testAPI() {
            try {
                const res = await fetch('http://localhost:3001/api/health');
                const data = await res.json();
                document.getElementById('status').textContent = 'üü¢ Online';
                alert('‚úì API Online!\n\n' + data.service);
            } catch(e) {
                document.getElementById('status').textContent = 'üî¥ Offline';
                alert('‚úó API Offline');
            }
        }

        function openCustomersDB() {
            window.location.href = '/customers.html';
        }

        window.testAPI = testAPI;
        window.openCustomersDB = openCustomersDB;

        // Initial test
        testAPI();
    </script>
</body>
</html>
