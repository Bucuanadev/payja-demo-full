// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===== ADMINISTRADORES =====
model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("OPERATOR") // SUPER_ADMIN, ADMIN, OPERATOR
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

// ===== CLIENTES =====
model Customer {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  name        String?
  nuit        String?  @unique // Número Único de Identificação Tributária
  dateOfBirth DateTime?
  address     String?
  district    String?
  province    String?
  
  // Status
  verified    Boolean  @default(false)
  blocked     Boolean  @default(false)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastAccess  DateTime?

  // Relationships
  loans       Loan[]
  scoringResults ScoringResult[]
  ussdSessions   UssdSession[]

  @@map("customers")
}

// ===== SESSÕES USSD =====
model UssdSession {
  id          String   @id @default(uuid())
  sessionId   String   @unique
  phoneNumber String
  
  // Estado da sessão
  currentStep String   @default("MENU_PRINCIPAL")
  state       String?  @default("{}") // JSON string - Dados temporários da sessão
  isActive    Boolean  @default(true)
  
  // Timestamps
  startedAt   DateTime @default(now())
  lastActivity DateTime @default(now())
  endedAt     DateTime?
  
  // Relationships
  customer    Customer? @relation(fields: [phoneNumber], references: [phoneNumber])

  @@map("ussd_sessions")
}

// ===== EMPRÉSTIMOS =====
model Loan {
  id              String   @id @default(uuid())
  customerId      String
  
  // Detalhes do empréstimo
  amount          Float
  interestRate    Float    @default(15.0)
  termMonths      Int
  purpose         String?
  
  // Valores calculados
  totalAmount     Float    // amount + juros
  monthlyPayment  Float
  
  // Status: PENDING, ANALYZING, APPROVED, REJECTED, DISBURSED, ACTIVE, COMPLETED, OVERDUE, DEFAULTED
  status          String   @default("PENDING")
  approvedBy      String?
  approvedAt      DateTime?
  rejectedReason  String?
  
  // Scoring
  scoringId       String?  @unique
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  disbursedAt     DateTime?
  dueDate         DateTime?
  
  // Relationships
  customer        Customer @relation(fields: [customerId], references: [id])
  scoring         ScoringResult? @relation(fields: [scoringId], references: [id])
  payments        Payment[]

  @@map("loans")
}

// ===== SCORING DE CRÉDITO =====
model ScoringResult {
  id          String   @id @default(uuid())
  customerId  String
  
  // Score final
  finalScore  Int      // 300-850
  risk        String   // VERY_LOW, LOW, MEDIUM, HIGH, VERY_HIGH
  
  // Fatores do scoring
  factors     String   @default("{}") // JSON string - Detalhes dos fatores calculados
  
  // Decisão automática
  decision    String   // APPROVED, REJECTED, MANUAL_REVIEW
  maxAmount   Float?   // Valor máximo aprovado
  
  // Timestamps
  calculatedAt DateTime @default(now())
  
  // Relationships
  customer    Customer @relation(fields: [customerId], references: [id])
  loan        Loan?

  @@map("scoring_results")
}

// ===== PAGAMENTOS =====
model Payment {
  id              String   @id @default(uuid())
  loanId          String
  
  // Detalhes do pagamento
  amount          Float
  paymentMethod   String   // M_PESA, BANK_TRANSFER, CASH, OTHER
  reference       String?  // Referência do pagamento (M-Pesa, etc)
  
  // Status: PENDING, COMPLETED, FAILED, CANCELLED
  status          String   @default("PENDING")
  
  // Timestamps
  dueDate         DateTime
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  
  // Relationships
  loan            Loan @relation(fields: [loanId], references: [id])

  @@map("payments")
}

// ===== LOGS DE AUDITORIA =====
model AuditLog {
  id          String   @id @default(uuid())
  
  // Quem fez
  userId      String   // Admin ID
  userType    String   // ADMIN, SYSTEM
  
  // O que foi feito
  action      String   // CREATE_LOAN, APPROVE_LOAN, etc
  entity      String   // LOAN, CUSTOMER, etc
  entityId    String
  
  // Detalhes
  changes     String?  @default("{}") // JSON string
  ipAddress   String?
  userAgent   String?
  
  // Timestamp
  createdAt   DateTime @default(now())

  @@map("audit_logs")
}
