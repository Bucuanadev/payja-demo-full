generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("OPERATOR")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model Customer {
  id             String          @id @default(uuid())
  phoneNumber    String          @unique
  name           String?
  nuit           String?         @unique
  dateOfBirth    DateTime?
  address        String?
  district       String?
  province       String?
  biNumber       String?
  biIssueDate    String?
  biExpiryDate   String?
  profession     String?
  salaryBank     String?
  salary         Float?
  channel        String          @default("APP")
  verified       Boolean         @default(false)
  blocked        Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  lastAccess     DateTime?
  creditLimit    Float?
  email          String?
  creditScore    Int?
  accountNumber  String?
  accountType    String?
  loans          Loan[]
  scoringResults ScoringResult[]

  @@map("customers")
}

model UssdSession {
  id           String    @id @default(uuid())
  sessionId    String    @unique
  phoneNumber  String
  currentStep  String    @default("MAIN")
  state        String?   @default("{}")
  isActive     Boolean   @default(true)
  otpCode      String?
  otpExpiresAt DateTime?
  otpAttempts  Int       @default(0)
  customerId   String?
  startedAt    DateTime  @default(now())
  lastActivity DateTime  @default(now())
  endedAt      DateTime?

  @@index([phoneNumber])
  @@index([sessionId])
  @@index([otpCode])
  @@map("ussd_sessions")
}

model Loan {
  id                  String         @id @default(uuid())
  customerId          String
  amount              Float
  interestRate        Float          @default(15.0)
  termMonths          Int
  purpose             String?
  bankCode            String?
  bankName            String?
  channel             String         @default("APP")
  totalAmount         Float
  monthlyPayment      Float
  emolaCommission     Float?         @default(0.03)
  payjaCommission     Float?         @default(0.03)
  bankCommission      Float?         @default(0.08)
  totalCommission     Float?
  commissionBreakdown String?        @default("{}")
  status              String         @default("PENDING")
  approvedBy          String?
  approvedAt          DateTime?
  rejectedReason      String?
  scoringId           String?        @unique
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  disbursedAt         DateTime?
  dueDate             DateTime?
  scoring             ScoringResult? @relation(fields: [scoringId], references: [id])
  customer            Customer       @relation(fields: [customerId], references: [id])
  payments            Payment[]
  transactions        Transaction[]

  @@map("loans")
}

model ScoringResult {
  id           String   @id @default(uuid())
  customerId   String
  finalScore   Int
  risk         String
  factors      String   @default("{}")
  decision     String
  maxAmount    Float?
  calculatedAt DateTime @default(now())
  loan         Loan?
  customer     Customer @relation(fields: [customerId], references: [id])

  @@map("scoring_results")
}

model Payment {
  id            String        @id @default(uuid())
  loanId        String
  amount        Float
  paymentMethod String
  reference     String?
  status        String        @default("PENDING")
  dueDate       DateTime
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  installments  Installment[]
  loan          Loan          @relation(fields: [loanId], references: [id])

  @@map("payments")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  userType  String
  action    String
  entity    String
  entityId  String
  changes   String?  @default("{}")
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model Transaction {
  id          String    @id @default(uuid())
  loanId      String?
  type        String
  description String
  from        String
  to          String
  amount      Float
  currency    String    @default("MZN")
  externalRef String?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  completedAt DateTime?
  loan        Loan?     @relation(fields: [loanId], references: [id])

  @@map("transactions")
}

model BankValidation {
  id             String    @id @default(uuid())
  customerId     String
  bankCode       String
  accountNumber  String?
  phoneNumber    String
  nuit           String?
  fullName       String?
  validated      Boolean   @default(false)
  validatedAt    DateTime?
  validationData String?   @default("{}")
  status         String    @default("PENDING")
  errorMessage   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("bank_validations")
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  category    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_configs")
}

model Installment {
  id                String    @id @default(uuid())
  loanId            String
  paymentId         String?
  installmentNumber Int
  principalAmount   Float
  interestAmount    Float
  totalAmount       Float
  lateFee           Float     @default(0)
  lateDays          Int       @default(0)
  status            String    @default("PENDING")
  dueDate           DateTime
  paidDate          DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  payment           Payment?  @relation(fields: [paymentId], references: [id])

  @@map("installments")
}

model SmsLog {
  id          String    @id @default(uuid())
  phoneNumber String
  message     String
  type        String
  status      String    @default("PENDING")
  sentAt      DateTime?
  deliveredAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([phoneNumber])
  @@index([createdAt])
  @@map("sms_logs")
}

model BankPartner {
  id                   String    @id @default(uuid())
  code                 String    @unique
  name                 String
  apiUrl               String
  apiKey               String?
  healthEndpoint       String    @default("/api/health")
  eligibilityEndpoint  String    @default("/api/validacao/verificar")
  capacityEndpoint     String    @default("/api/capacidade/consultar")
  disbursementEndpoint String    @default("/api/desembolso/executar")
  loansEndpoint        String    @default("/api/emprestimos/consultar")
  webhookEndpoint      String    @default("/api/webhooks/pagamento")
  timeout              Int       @default(30000)
  retryAttempts        Int       @default(3)
  active               Boolean   @default(true)
  verified             Boolean   @default(false)
  description          String?
  contactEmail         String?
  contactPhone         String?
  lastHealthCheck      DateTime?
  lastHealthStatus     String?
  totalRequests        Int       @default(0)
  successfulRequests   Int       @default(0)
  failedRequests       Int       @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@map("bank_partners")
}
