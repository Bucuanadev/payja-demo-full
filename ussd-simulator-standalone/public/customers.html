<!DOCTYPE html>
<html lang="pt-MZ">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes Registados - USSD Simulator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 40px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; gap: 20px; }
        .header h1 { color: #1c1c1e; font-size: 32px; margin-bottom: 5px; }
        .header-subtitle { color: #999; font-size: 14px; }
        .header-actions { display: flex; gap: 10px; }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f0f0f0; color: #1c1c1e; border: 2px solid #e0e0e0; }
        .btn-secondary:hover { background: #e0e0e0; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(102,126,234,0.2); }
        .stat-number { font-size: 36px; font-weight: 700; margin-bottom: 10px; }
        .stat-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; }
        .filters { display: flex; gap: 20px; margin-bottom: 30px; align-items: center; }
        .search-box { flex: 1; display: flex; align-items: center; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 10px; overflow: hidden; transition: all 0.3s; }
        .search-box:focus-within { border-color: #667eea; background: #f0f7ff; }
        .search-box i { color: #999; padding: 0 15px; }
        .search-box input { flex: 1; border: none; outline: none; padding: 12px 0; background: transparent; font-size: 14px; }
        .table-wrapper { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; color: #667eea; font-weight: 600; text-align: left; padding: 15px 20px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e0e0e0; }
        td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; color: #1c1c1e; font-size: 14px; }
        tbody tr { transition: all 0.2s; cursor: pointer; }
        tbody tr:hover { background: #f8f9fa; }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .badge-verified { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .actions { display: flex; gap: 10px; }
        .btn-small { padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-small:hover { background: #5568d3; }
        .message { padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { font-size: 24px; font-weight: 700; margin-bottom: 25px; color: #1c1c1e; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .modal-field { margin-bottom: 18px; }
        .modal-label { display: block; font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .modal-value { font-size: 15px; color: #1c1c1e; padding: 10px 12px; background: #f8f9fa; border-radius: 8px; word-break: break-word; }
        .modal-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0; }
        .modal-section:last-child { border-bottom: none; margin-bottom: 0; }
        .modal-section-title { font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .modal-grid .modal-field { margin-bottom: 0; }
        .modal-full { grid-column: 1 / -1; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .empty-state { text-align: center; padding: 60px 30px; color: #999; }
        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; gap: 20px; }
            .header h1 { font-size: 24px; }
            .header-actions { width: 100%; justify-content: center; }
            .stats { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            table { font-size: 12px; }
            th, td { padding: 12px 8px; }
            .modal-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><i class="fas fa-users"></i> Clientes Registados</h1>
                <div class="header-subtitle">Sincronizados via PayJA → Simulator • Última sincronização: <span id="last-sync">—</span> • Fonte: <span id="source-label">PayJA (direto)</span></div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="location.href='/'">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button class="btn btn-primary" onclick="refreshData(true)">
                    <i class="fas fa-sync"></i> Atualizar
                </button>
            </div>
        </div>

        <div class="content">
            <div id="message"></div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label">Total de Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="verified-count">0</div>
                    <div class="stat-label">Clientes Verificados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-count">0</div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="credit-total">0</div>
                    <div class="stat-label">Crédito Total</div>
                </div>
            </div>

            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search" placeholder="Buscar por nome ou telefone..." onkeyup="filterTable()">
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
                <p>Carregando dados...</p>
            </div>

            <div id="content" style="display: none;">
                <div class="table-wrapper">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>Telefone</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>Limite de Crédito</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>

            <div id="empty" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>Nenhum cliente registado ainda</p>
            </div>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Detalhes do Cliente</div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://155.138.227.26:3001/api';
        let allCustomers = [];

        async function loadCustomers() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('content');
            const empty = document.getElementById('empty');

            loading.style.display = 'block';
            content.style.display = 'none';
            empty.style.display = 'none';

            try {
                let usedSource = 'Base local (simulador)';
                const response = await fetch(`${API_URL}/customers`, { cache: 'no-store' });
                const data = await response.json();
                if (response.ok && Array.isArray(data)) {
                    allCustomers = data;
                } else if (response.ok && data.customers) {
                    allCustomers = data.customers;
                } else {
                    showMessage('Erro ao carregar clientes', 'error');
                    empty.style.display = 'block';
                    return;
                }
                setSourceLabel(usedSource);
                updateStats(allCustomers);
                renderTable(allCustomers);
                content.style.display = 'block';
                if (allCustomers.length === 0) empty.style.display = 'block';
            } catch (err) {
                console.error('Erro:', err);
                showMessage('Erro de conexão: ' + err.message, 'error');
                empty.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function setSourceLabel(text) {
            const el = document.getElementById('source-label');
            if (el) el.textContent = text;
        }

        function updateStats(customers) {
            const verified = customers.filter(c => c.verified).length;
            const pending = customers.filter(c => !c.verified).length;
            const creditTotal = customers.reduce((sum, c) => sum + (Number(c.creditLimit) || 0), 0);
            document.getElementById('total-count').textContent = customers.length;
            document.getElementById('verified-count').textContent = verified;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('credit-total').textContent = creditTotal.toLocaleString('pt-MZ');
        }

        function renderTable(customers) {
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = customers.map(customer => `
                <tr onclick="viewDetails('${customer.phoneNumber}')">
                    <td><strong>${customer.phoneNumber || '—'}</strong></td>
                    <td>${customer.name || '—'}</td>
                    <td>${getStatusBadge(customer.verified)}</td>
                    <td>${formatNumber(customer.creditLimit)} MZN</td>
                    <td>
                        <div class="actions">
                            <button class="btn-small" onclick="event.stopPropagation(); viewDetails('${customer.phoneNumber}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(verified) {
            if (verified) return '<span class="badge badge-verified"><i class="fas fa-check"></i> Verificado</span>';
            return '<span class="badge badge-pending"><i class="fas fa-hourglass-half"></i> Pendente</span>';
        }

        function formatNumber(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('pt-MZ', { maximumFractionDigits: 0 });
        }

        function formatDate(dateString) {
            if (!dateString) return '—';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-MZ');
        }

        function filterTable() {
            const search = document.getElementById('search').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                (c.phoneNumber && c.phoneNumber.toLowerCase().includes(search)) ||
                (c.name && c.name.toLowerCase().includes(search))
            );
            renderTable(filtered);
        }

        function viewDetails(phoneNumber) {
            const customer = allCustomers.find(c => c.phoneNumber === phoneNumber);
            if (!customer) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="modal-section">
                    <div class="modal-section-title">Informações Pessoais</div>
                    <div class="modal-grid">
                        <div class="modal-field"><div class="modal-label">Telefone</div><div class="modal-value">${customer.phoneNumber || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">Nome</div><div class="modal-value">${customer.name || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">NUIT</div><div class="modal-value">${customer.nuit || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">Número de BI</div><div class="modal-value">${customer.biNumber || '—'}</div></div>
                        <div class="modal-field modal-full"><div class="modal-label">Email</div><div class="modal-value">${customer.email || '—'}</div></div>
                    </div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">Informações Bancárias</div>
                    <div class="modal-grid">
                        <div class="modal-field"><div class="modal-label">Número da Conta</div><div class="modal-value">${customer.accountNumber || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">Tipo de Conta</div><div class="modal-value">${customer.accountType || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">Banco Empregador</div><div class="modal-value">${customer.salaryBank || '—'}</div></div>
                    </div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">Informações de Crédito</div>
                    <div class="modal-grid">
                        <div class="modal-field"><div class="modal-label">Limite de Crédito</div><div class="modal-value">${formatNumber(customer.creditLimit)} MZN</div></div>
                        <div class="modal-field"><div class="modal-label">Score de Crédito</div><div class="modal-value">${customer.creditScore || '—'}</div></div>
                        <div class="modal-field"><div class="modal-label">Salário Mensal</div><div class="modal-value">${formatNumber(customer.salary)} MZN</div></div>
                    </div>
                </div>
                <div class="modal-section">
                    <div class="modal-section-title">Status</div>
                    <div class="modal-grid">
                        <div class="modal-field"><div class="modal-label">Situação</div><div class="modal-value">${getStatusBadge(customer.verified)}</div></div>
                        <div class="modal-field"><div class="modal-label">Data de Registo</div><div class="modal-value">${formatDate(customer.createdAt)}</div></div>
                    </div>
                </div>
            `;
            document.getElementById('detailsModal').classList.add('active');
        }

        function showMessage(msg, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message ' + type;
            messageDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> ${msg}`;
            setTimeout(() => { messageDiv.innerHTML = ''; messageDiv.className = ''; }, 4000);
        }

        async function refreshData(triggerSync = false) {
            if (triggerSync) {
                try {
                    const resp = await fetch(`${API_URL}/sync-customers`, { method: 'POST' });
                    if (resp.ok) {
                        const payload = await resp.json().catch(() => ({}));
                        if (payload.syncedAt) {
                            updateLastSync(payload.syncedAt);
                        } else {
                            updateLastSync(new Date().toISOString());
                        }
                    } else {
                        updateLastSync(new Date().toISOString());
                    }
                } catch {}
            }
            loadCustomers();
        }

        function updateLastSync(iso) {
            const el = document.getElementById('last-sync');
            try {
                const d = new Date(iso);
                el.textContent = d.toLocaleString('pt-MZ', { hour12: false });
            } catch {
                el.textContent = 'agora';
            }
        }

        document.getElementById('detailsModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailsModal') document.getElementById('detailsModal').classList.remove('active');
        });

        loadCustomers();
        // Pull fresh data directly from PayJA then refresh every 30s
        setInterval(() => refreshData(true), 30000);
    </script>
</body>
</html>
