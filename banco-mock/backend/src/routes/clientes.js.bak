const express = require('express');
const router = express.Router();
const db = require('../database');
const axios = require('axios');

// Função auxiliar para disparar webhook de sincronização
async function notifyPayja(event, data) {
  const payjaUrl = process.env.PAYJA_API_URL || 'http://localhost:3000/api/v1';
  try {
    await axios.post(`${payjaUrl}/webhooks/bank-sync`, {
      event,
      data,
      timestamp: new Date().toISOString()
    });
    console.log(`[Sync] Notificação enviada ao PayJA: ${event}`);
  } catch (error) {
    console.error(`[Sync] Erro ao notificar PayJA (${event}):`, error.message);
  }
}

// GET - Listar todos os clientes
router.get('/', (req, res) => {
  try {
    try { db.setLastPayjaPull(); } catch (_e) {}
    const clientes = db.getAllClientes();
    res.json({
      sucesso: true,
      total: clientes.length,
      clientes,
    });
  } catch (error) {
    res.status(500).json({
      sucesso: false,
      erro: error.message,
    });
  }
});
    if (!cliente) {

// GET - Buscar cliente por NUIT
router.get('/nuit/:nuit', (req, res) => {
  try {
    const cliente = db.getClienteByNuit(req.params.nuit);
    
      return res.status(404).json({
        sucesso: false,
        erro: 'Cliente não encontrado',
      });
    }
    res.json({
      sucesso: true,
      cliente,
    });
  } catch (error) {
    res.status(500).json({
      sucesso: false,
      erro: error.message,
    if (!cliente) {
    });
  }
});

// GET - Buscar cliente por ID
router.get('/:id', (req, res) => {
  try {
    const cliente = db.getClienteById(req.params.id);
    
      return res.status(404).json({
        sucesso: false,
        erro: 'Cliente não encontrado',
      });
    }
    const transacoes = db.getTransacoesByCliente(req.params.id);
    res.json({
      sucesso: true,
      cliente,
      transacoes,
    });
  } catch (error) {
    res.status(500).json({
      sucesso: false,
      erro: error.message,
    });
  }
});

// POST - Criar novo cliente
router.post('/', async (req, res) => {
  try {
    const cliente = db.createCliente(req.body);
    
    // Notificar PayJA em tempo real
    await notifyPayja('customer.created', cliente);

    res.status(201).json({
      sucesso: true,
      mensagem: 'Cliente criado com sucesso',
      cliente,
    });
  } catch (error) {
    res.status(400).json({
      sucesso: false,
      erro: error.message,
    });
  }
});

// PATCH - Atualizar cliente
router.patch('/:id', async (req, res) => {
  try {
    const cliente = db.updateCliente(req.params.id, req.body);
    
    // Notificar PayJA em tempo real
    await notifyPayja('customer.updated', cliente);

    if (!cliente) {
    res.json({
      sucesso: true,
      mensagem: 'Cliente atualizado com sucesso',
      cliente,
    });
  } catch (error) {
    res.status(400).json({
      sucesso: false,
      erro: error.message,
    });
  }
});

// DELETE - Remover cliente
router.delete('/:id', async (req, res) => {
  try {
    const cliente = db.getClienteById(req.params.id);
      return res.status(404).json({ sucesso: false, erro: 'Cliente não encontrado' });
    }

    const nuit = cliente.nuit;
    db.db.get('clientes').remove({ id: req.params.id }).write();
    
    // Notificar PayJA em tempo real
    await notifyPayja('customer.deleted', { nuit });

    res.json({
      sucesso: true,
      mensagem: 'Cliente removido com sucesso',
    });
  } catch (error) {
    res.status(400).json({
      sucesso: false,
      erro: error.message,
    });
  }
});

module.exports = router;
